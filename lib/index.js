"use strict";
/**
 * Created by user on 2018/11/28/028.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const crossSpawn = require("cross-spawn-extra");
const JSON5 = require("json5");
const _validateNpmPackageName = require("validate-npm-package-name");
const fs = require("fs-extra");
const path = require("path");
function npmVersion(npmClient, cwd) {
    let args = [
        'version',
    ];
    npmClient = npmClient || 'npm';
    if (npmClient === 'yarn') {
        args = [
            'versions',
        ];
    }
    let cp = crossSpawn.sync(npmClient, args, {
        cwd,
        stripAnsi: true,
    });
    if (cp.error) {
        throw cp.error;
    }
    let output = cp.stdout.toString()
        .replace(/^yarn versions [^\n]+$/gm, '')
        .replace(/^Done in [^\n]+$/gm, '')
        .replace(/^\s+|\s+$/g, '');
    let json = JSON5.parse(output);
    return json;
}
exports.npmVersion = npmVersion;
function getTargetDir(options) {
    let targetDir;
    let targetName = options.targetName || null;
    let { inputName, cwd, hasWorkspace, workspacePrefix } = options;
    if (hasWorkspace && !workspacePrefix) {
        throw new RangeError(`can't found workspace prefix`);
    }
    if (targetName) {
        validateNpmPackageName(targetName, true);
    }
    if (inputName) {
        targetName = targetName || inputName;
        let ret = validateNpmPackageName(inputName, true);
        let name = inputName;
        let basePath;
        if (hasWorkspace) {
            basePath = path.join(hasWorkspace, workspacePrefix);
        }
        else {
            basePath = cwd;
        }
        if (ret.scopedPackagePattern) {
            name = name
                .replace(/[\/\\]+/g, '_')
                .replace(/^@/g, '');
            if (!fs.pathExistsSync(path.join(basePath, ret.subname))) {
                name = ret.subname;
            }
        }
        targetDir = path.resolve(basePath, name);
    }
    else {
        targetDir = cwd;
    }
    return {
        targetDir,
        targetName,
        cwd,
    };
}
exports.getTargetDir = getTargetDir;
const scopedPackagePattern = new RegExp('^(?:@([^/]+?)[/])?([^/]+?)$');
function validateNpmPackageName(name, throwErr) {
    let ret = _validateNpmPackageName(name);
    ret.name = name;
    if (!ret.errors || !ret.errors.length) {
        const nameMatch = name.match(scopedPackagePattern);
        if (nameMatch) {
            ret.scopedPackagePattern = true;
            ret.user = nameMatch[1];
            ret.subname = nameMatch[2];
        }
        else {
            ret.scopedPackagePattern = false;
        }
    }
    else if (throwErr) {
        throw new RangeError(ret.errors.concat(ret.warnings || []).join(' ; '));
    }
    return ret;
}
exports.validateNpmPackageName = validateNpmPackageName;
exports.defaultCopyStaticFiles = Object.freeze([
    ['.npmignore', 'file/npmignore'],
    ['.gitignore', 'file/gitignore'],
    ['.eslintignore', 'file/eslintignore'],
    ['.nvmrc', 'file/nvmrc'],
    ['.browserslistrc', 'file/browserslistrc'],
    ['tsconfig.json.tpl', 'file/tsconfig.json.tpl', 'tsconfig.json'],
    ['.eslintrc.json.tpl', 'file/eslintrc.json.tpl', '.eslintrc.json'],
]);
function copyStaticFiles(file_map, options) {
    if (!options.cwd || typeof options.cwd != 'string') {
        throw new TypeError(`options.cwd must is string`);
    }
    if (!fs.pathExistsSync(options.cwd)) {
        throw new TypeError(`options.cwd not exists`);
    }
    let copyOptions = {
        overwrite: options.overwrite || false,
        preserveTimestamps: true,
        errorOnExist: false,
    };
    const { cwd } = options;
    const staticRoot = options.staticRoot || __dirname;
    let ls;
    if (Array.isArray(file_map)) {
        ls = Object.values(file_map);
    }
    else {
        ls = Object.entries(file_map);
    }
    ls = ls.filter(v => v && Array.isArray(v) && v.length > 1);
    if (!ls.length) {
        throw new TypeError(`file_map is not file map`);
    }
    ls
        .forEach(function ([a, b, c]) {
        let fa = path.join(cwd, a);
        let fb = path.join(staticRoot, b);
        if (c != null) {
            let fc = path.join(cwd, c);
            if (fs.existsSync(fc)) {
                return;
            }
        }
        if (!fs.existsSync(fb)) {
            throw new Error(`file not exists. ${fb}`);
        }
        fs.copySync(fb, fa, copyOptions);
    });
}
exports.copyStaticFiles = copyStaticFiles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsZ0RBQWlEO0FBQ2pELCtCQUFnQztBQUVoQyxxRUFBc0U7QUFDdEUsK0JBQWdDO0FBQ2hDLDZCQUE4QjtBQUU5QixTQUFnQixVQUFVLENBQUMsU0FBa0IsRUFBRSxHQUFZO0lBRTFELElBQUksSUFBSSxHQUFHO1FBQ1YsU0FBUztLQUNULENBQUM7SUFFRixTQUFTLEdBQUcsU0FBUyxJQUFJLEtBQUssQ0FBQztJQUUvQixJQUFJLFNBQVMsS0FBSyxNQUFNLEVBQ3hCO1FBQ0MsSUFBSSxHQUFHO1lBQ04sVUFBVTtTQUNWLENBQUE7S0FDRDtJQUVELElBQUksRUFBRSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRTtRQUN6QyxHQUFHO1FBQ0gsU0FBUyxFQUFFLElBQUk7S0FDZixDQUFDLENBQUM7SUFFSCxJQUFJLEVBQUUsQ0FBQyxLQUFLLEVBQ1o7UUFDQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUE7S0FDZDtJQUVELElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFO1NBQy9CLE9BQU8sQ0FBQywwQkFBMEIsRUFBRSxFQUFFLENBQUM7U0FDdkMsT0FBTyxDQUFDLG9CQUFvQixFQUFFLEVBQUUsQ0FBQztTQUNqQyxPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUMxQjtJQUVELElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFL0IsT0FBTyxJQUFJLENBQUE7QUFDWixDQUFDO0FBbENELGdDQWtDQztBQUVELFNBQWdCLFlBQVksQ0FBQyxPQU81QjtJQUVBLElBQUksU0FBaUIsQ0FBQztJQUN0QixJQUFJLFVBQVUsR0FBVyxPQUFPLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQztJQUNwRCxJ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QUMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztJQUUzRCxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFDZDtRQUNDLE1BQU0sSUFBSSxTQUFTLENBQUMsMEJBQTBCLENBQUMsQ0FBQTtLQUMvQztJQUVELEVBQUU7U0FDQSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTNCLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzNCLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRWxDLElBQUksQ0FBQyxJQUFJLElBQUksRUFDYjtZQUNDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBRTNCLElBQUksRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFDckI7Z0JBQ0MsT0FBTzthQUNQO1NBQ0Q7UUFFRCxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFDdEI7WUFDQyxNQUFNLElBQUksS0FBSyxDQUFDLG9CQUFvQixFQUFFLEVBQUUsQ0FBQyxDQUFBO1NBQ3pDO1FBRUQsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ2xDLENBQUMsQ0FBQyxDQUNGO0FBQ0YsQ0FBQztBQW5FRCwwQ0FtRUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE4LzExLzI4LzAyOC5cbiAqL1xuXG5pbXBvcnQgY3Jvc3NTcGF3biA9IHJlcXVpcmUoJ2Nyb3NzLXNwYXduLWV4dHJhJyk7XG5pbXBvcnQgSlNPTjUgPSByZXF1aXJlKCdqc29uNScpO1xuXG5pbXBvcnQgX3ZhbGlkYXRlTnBtUGFja2FnZU5hbWUgPSByZXF1aXJlKCd2YWxpZGF0ZS1ucG0tcGFja2FnZS1uYW1lJyk7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBucG1WZXJzaW9uKG5wbUNsaWVudD86IHN0cmluZywgY3dkPzogc3RyaW5nKVxue1xuXHRsZXQgYXJncyA9IFtcblx0XHQndmVyc2lvbicsXG5cdF07XG5cblx0bnBtQ2xpZW50ID0gbnBtQ2xpZW50IHx8ICducG0nO1xuXG5cdGlmIChucG1DbGllbnQgPT09ICd5YXJuJylcblx0e1xuXHRcdGFyZ3MgPSBbXG5cdFx0XHQndmVyc2lvbnMnLFxuXHRcdF1cblx0fVxuXG5cdGxldCBjcCA9IGNyb3NzU3Bhd24uc3luYyhucG1DbGllbnQsIGFyZ3MsIHtcblx0XHRjd2QsXG5cdFx0c3RyaXBBbnNpOiB0cnVlLFxuXHR9KTtcblxuXHRpZiAoY3AuZXJyb3IpXG5cdHtcblx0XHR0aHJvdyBjcC5lcnJvclxuXHR9XG5cblx0bGV0IG91dHB1dCA9IGNwLnN0ZG91dC50b1N0cmluZygpXG5cdFx0LnJlcGxhY2UoL155YXJuIHZlcnNpb25zIFteXFxuXSskL2dtLCAnJylcblx0XHQucmVwbGFjZSgvXkRvbmUgaW4gW15cXG5dKyQvZ20sICcnKVxuXHRcdC5yZXBsYWNlKC9eXFxzK3xcXHMrJC9nLCAnJylcblx0O1xuXG5cdGxldCBqc29uID0gSlNPTjUucGFyc2Uob3V0cHV0KTtcblxuXHRyZXR1cm4ganNvblxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGFyZ2V0RGlyKG9wdGlvbnM6IHtcblx0aW5wdXROYW1lOiBzdHJpbmcsXG5cdGN3ZDogc3RyaW5nLFxuXG5cdHRhcmdldE5hbWU/OiBzdHJpbmcsXG5cdGhhc1dvcmtzcGFjZT86IHN0cmluZyxcblx0d29ya3NwYWNlUHJlZml4Pzogc3RyaW5nLFxufSlcbntcblx0bGV0IHRhcmdldERpcjogc3RyaW5nO1xuXHRsZXQgdGFyZ2V0TmFtZTogc3RyaW5nID0gb3B0aW9ucy50YXJnZXROYW1lIHx8IG51bGw7XG5cdGxldCB7IGlucHV0TmFtZSwgY3dkLCBoYXNXb3Jrc3BhY2UsIHdvcmtzcGFjZVByZWZpeCB9ID0gb3B0aW9ucztcblxuXHRpZiAoaGFzV29ya3NwYWNlICYmICF3b3Jrc3BhY2VQcmVmaXgpXG5cdHtcblx0XHR0aHJvdyBuZXcgUmFuZ2VFcnJvcihgY2FuJ3QgZm91bmQgd29ya3NwYWNlIHByZWZpeGApO1xuXHR9XG5cblx0aWYgKHRhcmdldE5hbWUpXG5cdHtcblx0XHR2YWxpZGF0ZU5wbVBhY2thZ2VOYW1lKHRhcmdldE5hbWUsIHRydWUpO1xuXHR9XG5cblx0aWYgKGlucHV0TmFtZSlcblx0e1xuXHRcdHRhcmdldE5hbWUgPSB0YXJnZXROYW1lIHx8IGlucHV0TmFtZTtcblxuXHRcdGxldCByZXQgPSB2YWxpZGF0ZU5wbVBhY2thZ2VOYW1lKGlucHV0TmFtZSwgdHJ1ZSk7XG5cdFx0bGV0IG5hbWUgPSBpbnB1dE5hbWU7XG5cblx0XHRsZXQgYmFzZVBhdGg6IHN0cmluZztcblxuXHRcdGlmIChoYXNXb3Jrc3BhY2UpXG5cdFx0e1xuXHRcdFx0YmFzZVBhdGggPSBwYXRoLmpvaW4oaGFzV29ya3NwYWNlLCB3b3Jrc3BhY2VQcmVmaXgpO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0YmFzZVBhdGggPSBjd2Q7XG5cdFx0fVxuXG5cdFx0aWYgKHJldC5zY29wZWRQYWNrYWdlUGF0dGVybilcblx0XHR7XG5cdFx0XHRuYW1lID0gbmFtZVxuXHRcdFx0XHQucmVwbGFjZSgvW1xcL1xcXFxdKy9nLCAnXycpXG5cdFx0XHRcdC5yZXBsYWNlKC9eQC9nLCAnJylcblx0XHRcdDtcblxuXHRcdFx0aWYgKCFmcy5wYXRoRXhpc3RzU3luYyhwYXRoLmpvaW4oYmFzZVBhdGgsIHJldC5zdWJuYW1lKSkpXG5cdFx0XHR7XG5cdFx0XHRcdG5hbWUgPSByZXQuc3VibmFtZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHR0YXJnZXREaXIgPSBwYXRoLnJlc29sdmUoYmFzZVBhdGgsIG5hbWUpO1xuXG5cdH1cblx0ZWxzZVxuXHR7XG5cdFx0dGFyZ2V0RGlyID0gY3dkO1xuXHR9XG5cblx0cmV0dXJuIHtcblx0XHR0YXJnZXREaXIsXG5cdFx0dGFyZ2V0TmFtZSxcblx0XHRjd2QsXG5cdH1cbn1cblxuY29uc3Qgc2NvcGVkUGFja2FnZVBhdHRlcm4gPSBuZXcgUmVnRXhwKCdeKD86QChbXi9dKz8pWy9dKT8oW14vXSs/KSQnKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlTnBtUGFja2FnZU5hbWUobmFtZTogc3RyaW5nLCB0aHJvd0Vycj86IGJvb2xlYW4pXG57XG5cdGxldCByZXQ6IHtcblx0XHR2YWxpZEZvck5ld1BhY2thZ2VzOiBib29sZWFuLFxuXHRcdHZhbGlkRm9yT2xkUGFja2FnZXM6IGJvb2xlYW4sXG5cdFx0c2NvcGVkUGFja2FnZVBhdHRlcm46IGJvb2xlYW4sXG5cdFx0d2FybmluZ3M/OiBzdHJpbmdbXSxcblx0XHRlcnJvcnM/OiBzdHJpbmdbXSxcblxuXHRcdG5hbWU6IHN0cmluZyxcblx0XHR1c2VyPzogc3RyaW5nLFxuXHRcdHN1Ym5hbWU/OiBzdHJpbmcsXG5cblx0fSA9IF92YWxpZGF0ZU5wbVBhY2thZ2VOYW1lKG5hbWUpO1xuXG5cdHJldC5uYW1lID0gbmFtZTtcblxuXHRpZiAoIXJldC5lcnJvcnMgfHwgIXJldC5lcnJvcnMubGVuZ3RoKVxuXHR7XG5cdFx0Y29uc3QgbmFtZU1hdGNoID0gbmFtZS5tYXRjaChzY29wZWRQYWNrYWdlUGF0dGVybik7XG5cblx0XHRpZiAobmFtZU1hdGNoKVxuXHRcdHtcblx0XHRcdHJldC5zY29wZWRQYWNrYWdlUGF0dGVybiA9IHRydWU7XG5cblx0XHRcdHJldC51c2VyID0gbmFtZU1hdGNoWzFdO1xuXHRcdFx0cmV0LnN1Ym5hbWUgPSBuYW1lTWF0Y2hbMl07XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRyZXQuc2NvcGVkUGFja2FnZVBhdHRlcm4gPSBmYWxzZTtcblx0XHR9XG5cdH1cblx0ZWxzZSBpZiAodGhyb3dFcnIpXG5cdHtcblx0XHR0aHJvdyBuZXcgUmFuZ2VFcnJvcihyZXQuZXJyb3JzLmNvbmNhdChyZXQud2FybmluZ3MgfHwgW10pLmpvaW4oJyA7ICcpKTtcblx0fVxuXG5cdHJldHVybiByZXQ7XG59XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0Q29weVN0YXRpY0ZpbGVzID0gT2JqZWN0LmZyZWV6ZShbXG5cblx0WycubnBtaWdub3JlJywgJ2ZpbGUvbnBtaWdub3JlJ10sXG5cdFsnLmdpdGlnbm9yZScsICdmaWxlL2dpdGlnbm9yZSddLFxuXG5cdFsnLmVzbGludGlnbm9yZScsICdmaWxlL2VzbGludGlnbm9yZSddLFxuXG5cdFsnLm52bXJjJywgJ2ZpbGUvbnZtcmMnXSxcblx0WycuYnJvd3NlcnNsaXN0cmMnLCAnZmlsZS9icm93c2Vyc2xpc3RyYyddLFxuXG5cdFsndHNjb25maWcuanNvbi50cGwnLCAnZmlsZS90c2NvbmZpZy5qc29uLnRwbCcsICd0c2NvbmZpZy5qc29uJ10sXG5cblx0WycuZXNsaW50cmMuanNvbi50cGwnLCAnZmlsZS9lc2xpbnRyYy5qc29uLnRwbCcsICcuZXNsaW50cmMuanNvbiddLFxuXG5dKSBhcyBbc3RyaW5nLCBzdHJpbmcsIHN0cmluZz9dW107XG5cbmV4cG9ydCBmdW5jdGlvbiBjb3B5U3RhdGljRmlsZXMoZmlsZV9tYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gfCBbc3RyaW5nLCBzdHJpbmcsIHN0cmluZz9dW10sIG9wdGlvbnM6IHtcblx0Y3dkOiBzdHJpbmcsXG5cdHN0YXRpY1Jvb3Q/OiBzdHJpbmcsXG5cdG92ZXJ3cml0ZT86IGJvb2xlYW4sXG59KVxue1xuXHRpZiAoIW9wdGlvbnMuY3dkIHx8IHR5cGVvZiBvcHRpb25zLmN3ZCAhPSAnc3RyaW5nJylcblx0e1xuXHRcdHRocm93IG5ldyBUeXBlRXJyb3IoYG9wdGlvbnMuY3dkIG11c3QgaXMgc3RyaW5nYClcblx0fVxuXG5cdGlmICghZnMucGF0aEV4aXN0c1N5bmMob3B0aW9ucy5jd2QpKVxuXHR7XG5cdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihgb3B0aW9ucy5jd2Qgbm90IGV4aXN0c2ApXG5cdH1cblxuXHRsZXQgY29weU9wdGlvbnM6IGZzLkNvcHlPcHRpb25zU3luYyA9IHtcblx0XHRvdmVyd3JpdGU6IG9wdGlvbnMub3ZlcndyaXRlIHx8IGZhbHNlLFxuXHRcdHByZXNlcnZlVGltZXN0YW1wczogdHJ1ZSxcblx0XHRlcnJvck9uRXhpc3Q6IGZhbHNlLFxuXHR9O1xuXG5cdGNvbnN0IHsgY3dkIH0gPSBvcHRpb25zO1xuXHRjb25zdCBzdGF0aWNSb290ID0gb3B0aW9ucy5zdGF0aWNSb290IHx8IF9fZGlybmFtZTtcblxuXHRsZXQgbHM6IHN0cmluZ1tdW107XG5cblx0aWYgKEFycmF5LmlzQXJyYXkoZmlsZV9tYXApKVxuXHR7XG5cdFx0bHMgPSBPYmplY3QudmFsdWVzKGZpbGVfbWFwKVxuXHR9XG5cdGVsc2Vcblx0e1xuXHRcdGxzID0gT2JqZWN0LmVudHJpZXMoZmlsZV9tYXApXG5cdH1cblxuXHRscyA9IGxzLmZpbHRlcih2ID0+IHYgJiYgQXJyYXkuaXNBcnJheSh2KSAmJiB2Lmxlbmd0aCA+IDEpO1xuXG5cdGlmICghbHMubGVuZ3RoKVxuXHR7XG5cdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihgZmlsZV9tYXAgaXMgbm90IGZpbGUgbWFwYClcblx0fVxuXG5cdGxzXG5cdFx0LmZvckVhY2goZnVuY3Rpb24gKFthLCBiLCBjXSlcblx0XHR7XG5cdFx0XHRsZXQgZmEgPSBwYXRoLmpvaW4oY3dkLCBhKTtcblx0XHRcdGxldCBmYiA9IHBhdGguam9pbihzdGF0aWNSb290LCBiKTtcblxuXHRcdFx0aWYgKGMgIT0gbnVsbClcblx0XHRcdHtcblx0XHRcdFx0bGV0IGZjID0gcGF0aC5qb2luKGN3ZCwgYyk7XG5cblx0XHRcdFx0aWYgKGZzLmV4aXN0c1N5bmMoZmMpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmICghZnMuZXhpc3RzU3luYyhmYikpXG5cdFx0XHR7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihgZmlsZSBub3QgZXhpc3RzLiAke2ZifWApXG5cdFx0XHR9XG5cblx0XHRcdGZzLmNvcHlTeW5jKGZiLCBmYSwgY29weU9wdGlvbnMpO1xuXHRcdH0pXG5cdDtcbn1cbiJdfQ==